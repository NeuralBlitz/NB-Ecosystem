name: Database Migration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'alembic/**'
      - 'nb_omnibus_router/db/**'
      - '.github/workflows/migrations.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'alembic/**'
      - 'nb_omnibus_router/db/**'

env:
  PYTHON_VERSION: '3.11'
  POSTGRES_VERSION: '15'

jobs:
  lint-migrations:
    name: Lint Migration Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install ruff black
      
      - name: Lint migration files
        run: |
          ruff check alembic/versions/
          black --check alembic/versions/
      
      - name: Validate migration syntax
        run: |
          python -m py_compile alembic/versions/*.py

  test-migrations:
    name: Test Migration Cycle
    runs-on: ubuntu-latest
    needs: lint-migrations
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: neuralblitz
          POSTGRES_PASSWORD: neuralblitz_password
          POSTGRES_DB: neuralblitz_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install alembic sqlalchemy psycopg2-binary typer
      
      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U neuralblitz; do
            echo "Waiting for PostgreSQL..."
            sleep 1
          done
      
      - name: Test upgrade to head
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          alembic upgrade head
      
      - name: Verify database state
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          alembic current
      
      - name: Test downgrade to base
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          alembic downgrade base
      
      - name: Test full cycle
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          alembic upgrade head
          alembic downgrade base
          alembic upgrade head
      
      - name: Check data integrity
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          python -c "
          from sqlalchemy import create_engine, text
          engine = create_engine('$NEURALBLITZ_DATABASE_URL')
          with engine.connect() as conn:
              result = conn.execute(text('SELECT COUNT(*) FROM users'))
              print(f'Users count: {result.scalar()}')
              result = conn.execute(text('SELECT COUNT(*) FROM quantum_neurons'))
              print(f'Quantum neurons count: {result.scalar()}')
          "

  test-backup-restore:
    name: Test Backup and Restore
    runs-on: ubuntu-latest
    needs: lint-migrations
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_USER: neuralblitz
          POSTGRES_PASSWORD: neuralblitz_password
          POSTGRES_DB: neuralblitz_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install alembic sqlalchemy psycopg2-binary
      
      - name: Apply migrations
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          alembic upgrade head
      
      - name: Create backup
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          pg_dump --no-owner --no-acl "$NEURALBLITZ_DATABASE_URL" | gzip > backup_test.sql.gz
          ls -lh backup_test.sql.gz
      
      - name: Verify backup
        run: |
          if [ -s backup_test.sql.gz ]; then
            echo "Backup created successfully"
          else
            echo "Backup is empty!"
            exit 1
          fi
      
      - name: Test restore
        env:
          NEURALBLITZ_DATABASE_URL: postgresql://neuralblitz:neuralblitz_password@localhost:5432/neuralblitz_test
        run: |
          # Drop and recreate database
          psql "${NEURALBLITZ_DATABASE_URL%/*}/postgres" -c "DROP DATABASE IF EXISTS neuralblitz_test;"
          psql "${NEURALBLITZ_DATABASE_URL%/*}/postgres" -c "CREATE DATABASE neuralblitz_test;"
          
          # Restore
          gunzip -c backup_test.sql.gz | psql "$NEURALBLITZ_DATABASE_URL"
          
          # Verify
          psql "$NEURALBLITZ_DATABASE_URL" -c "SELECT COUNT(*) FROM users;"

  migration-check:
    name: Check Migration Status
    runs-on: ubuntu-latest
    needs: [test-migrations, test-backup-restore]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install alembic
      
      - name: Check migration history
        run: |
          echo "Migration History:"
          alembic history --verbose
      
      - name: Validate migration order
        run: |
          python -c "
          import os
          import re
          from pathlib import Path
          
          versions_dir = Path('alembic/versions')
          migrations = []
          
          for file in versions_dir.glob('*.py'):
              if file.name.startswith('__'):
                  continue
              match = re.match(r'(\d{4}_\d{2}_\d{2}_\d{4})-(\d+)_', file.name)
              if match:
                  migrations.append((match.group(1), match.group(2), file.name))
          
          migrations.sort(key=lambda x: (x[0], int(x[1])))
          
          print('Migration order:')
          for timestamp, num, name in migrations:
              print(f'  {timestamp}-{num}: {name}')
          
          # Check for gaps
          nums = [int(m[1]) for m in migrations]
          for i in range(1, len(nums)):
              if nums[i] != nums[i-1] + 1:
                  print(f'Warning: Gap detected between {nums[i-1]} and {nums[i]}')
          "

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [migration-check]
    if: always()
    
    steps:
      - name: Check job status
        run: |
          if [ "${{ needs.migration-check.result }}" == "success" ]; then
            echo "✅ All migration tests passed!"
          else
            echo "❌ Migration tests failed!"
            exit 1
          fi
